<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Next.js+Egg.jsé…ç½® Â· ç½—æ–‡è¿ªçš„åšå®¢</title><meta name="description" content="Next.js+Egg.jsé…ç½® - biaodigit"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="ç½—æ–‡è¿ªçš„åšå®¢"><link rel="alternate" href="/atom.xml" title="ç½—æ–‡è¿ªçš„åšå®¢" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/biaodigit" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://biaodigit.github.io/LeetCode/" target="_blank" class="nav-list-link">LEETCODE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Next.js+Egg.jsé…ç½®</h1><div class="post-info">2020å¹´1æœˆ7æ—¥</div><div class="post-content"><h2 id="Next-jsç®€ä»‹"><a href="#Next-jsç®€ä»‹" class="headerlink" title="Next.jsç®€ä»‹"></a>Next.jsç®€ä»‹</h2><p>Next.jsä½œä¸º<a href="https://reactjs.org/docs/create-a-new-react-app.html#nextjs" target="_blank" rel="noopener">Reactå®˜æ–¹é’¦å®š</a>çš„SSRè½»é‡çº§æ¡†æ¶ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p>
<ul>
<li>å¼€ç®±å³ç”¨ï¼Œæ”¯æŒ0é…ç½®å¼€å‘</li>
<li>æ”¯æŒçº¦å®šå¼è·¯ç”±</li>
<li>æ”¯æŒè‡ªå®šä¹‰æœåŠ¡ç«¯è·¯ç”±ï¼Œå¯ä»¥é…åˆå…¶ä»–Nodeæ¡†æ¶ä½¿ç”¨</li>
<li>æ¸è¿›å¼babelå’Œwebpacké…ç½®</li>
<li>æ”¯æŒå®¢æˆ·ç«¯æ¸²æŸ“</li>
<li>ç¤¾åŒºæ´»è·ƒï¼Œå›¢é˜Ÿä¸å¤ªç›‘</li>
<li>å¯¹å‰ç«¯æ–°æŠ€æœ¯æ”¯æŒè¾ƒä¸ºå…¨é¢ï¼Œæ¯”å¦‚AMPã€TypeScriptã€PWAã€Serverlessç­‰</li>
</ul>
<p>åœ¨Nemo FEä»¥Reactä¸ºä¸»è¦å¼€å‘æ¡†æ¶çš„å‰æä¸‹SEOé¡¹ç›®é‡æ„é€‰æ‹©Next.jså°±éå¸¸åˆé€‚</p>
<a id="more"></a>

<h2 id="Next-jsè‡ªå®šä¹‰é…ç½®"><a href="#Next-jsè‡ªå®šä¹‰é…ç½®" class="headerlink" title="Next.jsè‡ªå®šä¹‰é…ç½®"></a>Next.jsè‡ªå®šä¹‰é…ç½®</h2><p>å®˜æ–¹æ–‡æ¡£åœ¨è‡ªå®šä¹‰æœåŠ¡ç«¯è·¯ç”±çš„ä¾‹å­ä¸­ç»™å‡ºäº†ä¸€ä¸ªdemoï¼Œå¯ä»¥ç»™åé¢å’ŒEgg.jsé…ç½®æä¾›å‚è€ƒæ€§</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createServer &#125; = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; parse &#125; = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> next = <span class="built_in">require</span>(<span class="string">'next'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dev = process.env.NODE_ENV !== <span class="string">'production'</span></span><br><span class="line"><span class="keyword">const</span> app = next(&#123; dev &#125;)</span><br><span class="line"><span class="keyword">const</span> handle = app.getRequestHandler()</span><br><span class="line"></span><br><span class="line">app.prepare().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> parsedUrl = parse(req.url, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> &#123; pathname, query &#125; = parsedUrl</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pathname === <span class="string">'/a'</span>) &#123;</span><br><span class="line">      app.render(req, res, <span class="string">'/b'</span>, query)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pathname === <span class="string">'/b'</span>) &#123;</span><br><span class="line">      app.render(req, res, <span class="string">'/a'</span>, query)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      handle(req, res, parsedUrl)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).listen(<span class="number">3000</span>, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt; Ready on http://localhost:3000'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å¤§æ¦‚å¯ä»¥æ‹†åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†:<br></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dev = process.env.NODE_ENV !== <span class="string">'production'</span></span><br><span class="line"><span class="keyword">const</span> app = next(&#123; dev &#125;)</span><br><span class="line"><span class="keyword">const</span> handle = app.getRequestHandler()</span><br></pre></td></tr></table></figure>

<p>1.å¯¹nextè¿›è¡Œå®ä¾‹åŒ–ï¼Œç¼“å­˜ç¯å¢ƒå˜é‡ä»¥åŠä¸€ä¸ªå¤„ç†é¡µé¢èµ„æºè¯·æ±‚çš„æ–¹æ³•</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.prepare().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>2.å½“å‰æœŸçš„å®ä¾‹å’Œæ–¹æ³•éƒ½å‡†å¤‡å¥½ä»¥åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å¯åŠ¨æœåŠ¡äº†ï¼Œå¯åŠ¨httpæœåŠ¡ä¹‹å‰å…ˆè·‘äº†ä¸€æ¬¡<code>app.prepare</code>ï¼Œè€Œè¿™ä¸ª<code>app.prepare</code>æ˜¯å¹²ä»€ä¹ˆç”¨çš„å‘¢ï¼Œåœ¨è¿™é‡Œå¯ä»¥å…ˆä¸æ€¥ç€å»çœ‹prepareçš„æºç ï¼Œå¯ä»¥å…ˆå»çœ‹çœ‹nextå®˜æ–¹è„šæ‰‹æ¶æ˜¯æ€ä¹ˆè·‘èµ·æ¥çš„ã€‚</p>
<p>å®˜æ–¹ç»™å‡ºçš„å‘½ä»¤é…ç½®å¦‚ä¸‹ï¼š<br><img src="/2020/01/07/3/01.png" alt="01.png"><br>ä»¥<code>dev</code>ä¸ºä¾‹ï¼Œå¯ä»¥ä»nextæºç ä¸­æ‰¾åˆ°å¯¹åº”çš„<code>cli/next-dev.ts</code>æ–‡ä»¶</p>
<blockquote>
<p>next-dev.ts</p>
</blockquote>
<p><img src="/2020/01/07/3/02.png" alt="02.png"><br>å¯ä»¥çœ‹åˆ°åœ¨<code>dev</code>å¯åŠ¨å‘½ä»¤åŒæ ·è°ƒç”¨äº†<code>app.prepare</code>è¿™ä¸ªæ–¹æ³•ï¼Œè€Œå‰é¢é‚£ä¸ª<code>startServer</code>åˆæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œå¯ä»¥æ ¹æ®è·¯å¾„æ‰¾åˆ°å¯¹åº”æ–‡ä»¶</p>
<blockquote>
<p>start-server.ts</p>
</blockquote>
<p><img src="/2020/01/07/3/03.png" alt="03.png"></p>
<p>çœ‹åˆ°è¿™é‡Œå°±å¤§æ¦‚çŸ¥é“å®˜æ–¹å¯åŠ¨nextçš„æµç¨‹æ˜¯å…ˆå¯åŠ¨ä¸€ä¸ªhttpæœåŠ¡ï¼Œå¯åŠ¨å®Œåå†å»è°ƒç”¨<code>app.prepare</code>æ–¹æ³•ï¼Œé™¤äº†<code>dev</code>ç”Ÿäº§æ¨¡å¼ä¸‹çš„<code>start</code>ä¹Ÿæ˜¯åŒæ ·æµç¨‹ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™prepareå†…éƒ¨æ˜¯å¹²ä»€ä¹ˆçš„å·²ç»ä¸éœ€è¦å»çŸ¥é“ï¼Œæºç æ€ä¹ˆåšè¿™è¾¹è‡ªå®šä¹‰å¯åŠ¨nextå°±æ€ä¹ˆåš</p>
<p>è‡³äºæ˜¯å…ˆåˆ›å»ºhttpæœåŠ¡è¿˜æ˜¯å…ˆè·‘<code>app.prepare</code>æ–¹æ³•ä¹Ÿä¸é‡è¦ï¼Œåªè¦åœ¨å¼€å§‹åšè·¯ç”±åŒ¹é…å‰éƒ½å¯åŠ¨å®Œæˆå³å¯</p>
<h2 id="Egg-jsè‡ªå®šä¹‰é…ç½®"><a href="#Egg-jsè‡ªå®šä¹‰é…ç½®" class="headerlink" title="Egg.jsè‡ªå®šä¹‰é…ç½®"></a>Egg.jsè‡ªå®šä¹‰é…ç½®</h2><p>Egg.jsè‡ªå®šä¹‰é…ç½®è¾ƒç®€å•ï¼Œåªéœ€è¦åœ¨æ ¹ç›®å½•æ–°å»ºä¸€ä¸ª<code>app.js</code>ï¼Œè°ƒç”¨<code>beforeStart</code>å³å¯</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (app) =&gt; &#123;</span><br><span class="line">    app.beforeStart(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">       ...      </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>beforeStart</code>å®šä¹‰</p>
<blockquote>
<p>æ‰€æœ‰çš„é…ç½®å·²ç»åŠ è½½å®Œæ¯•,å¯ä»¥ç”¨æ¥åŠ è½½åº”ç”¨è‡ªå®šä¹‰çš„æ–‡ä»¶ï¼Œå¯åŠ¨è‡ªå®šä¹‰çš„æœåŠ¡</p>
</blockquote>
<h2 id="æ­å»ºæ€è·¯"><a href="#æ­å»ºæ€è·¯" class="headerlink" title="æ­å»ºæ€è·¯"></a>æ­å»ºæ€è·¯</h2><blockquote>
<p>æœ¬æ–‡é‡‡ç”¨çš„Next9.xç‰ˆæœ¬è¿›è¡Œé…ç½®ï¼Œå·²æˆåŠŸè¿›è¡Œä¸Šçº¿éªŒè¯</p>
</blockquote>
<p>Okï¼Œåœ¨åˆ†æå®ŒNext.jså’ŒEgg.jsçš„è‡ªå®šä¹‰é…ç½®è¿‡ç¨‹åï¼Œä¸‹é¢å¼€å§‹æ€è€ƒä¸‹ğŸ¤”æ€ä¹ˆæŠŠè¿™ä¸¤ä¸ªå®˜æ–¹å›¢é˜Ÿç›¸äº’æ’æ–¥çš„æ¡†æ¶ç»“åˆåœ¨ä¸€èµ·åšæˆè‡ªå·±æƒ³è¦çš„é…ç½®</p>
<p>å…ˆæ‹ä¸€ä¸‹æ­å»ºæ€è·¯ï¼š</p>
<ul>
<li>é¦–å…ˆè·¯ç”±æ˜¯ç”±Eggæ§åˆ¶è€Œä¸æ˜¯ä½¿ç”¨Nextçš„çº¦å®šå¼è·¯ç”±ï¼Œå› ä¸ºå¥‘åˆSEOéœ€æ±‚ä¸€ä¸ªé¡µé¢å¯èƒ½è¢«å¤šä¸ªè·¯ç”±ä½¿ç”¨ï¼Œæ‰€ä»¥ç”¨Eggæ§åˆ¶è·¯ç”±æ›´åˆé€‚</li>
<li>æ—¢ç„¶é¡¹ç›®ç”¨Eggå¯åŠ¨ä¹Ÿå°±æ˜¯Nextéœ€è¦è‡ªå®šä¹‰åœ¨Eggå¯åŠ¨çš„æ—¶å€™å®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–è¦åšä¸¤ä»¶äº‹æƒ…ï¼š<ul>
<li>1.è‡ªå®šä¹‰ä¸€ä¸ªrenderæ–¹æ³•ç„¶åæŒ‚è½½åœ¨ä¸ŠEggä¸Šï¼Œå› ä¸ºViewå±‚æ¸²æŸ“æ˜¯ç”±Nextå»å®Œæˆï¼Œç„¶åé€šè¿‡çš„Eggçš„Controllerè¿”å›ç»™å®¢æˆ·ç«¯</li>
<li>2.ä¸Šæ–‡æåˆ°Nextæœ‰ä¸€ä¸ª<code>getRequestHandler</code>çš„æ–¹æ³•ç”¨äºå¤„ç†è·¯ç”±å’Œé™æ€æ–‡ä»¶ï¼Œæ”¾åˆ°è¿™é‡Œè·¯ç”±æ˜¯ä¸ç”¨å¤„ç†å› ä¸ºè¿™äº‹æ˜¯Eggåšçš„ï¼Œä½†æ˜¯é™æ€èµ„æºè¿˜æ˜¯è¦ç”±Nextåšçš„ï¼Œæ‰€ä»¥ä¹Ÿåº”è¯¥æƒ³åŠæ³•æŠŠè¿™ä¸ªæ–¹æ³•æŒ‚åˆ°Eggä¸Š</li>
</ul>
</li>
<li>è€ƒè™‘åˆ°SEOéœ€æ±‚éœ€è¦ä½¿ç”¨Googleçš„<code>AMP</code>æ¡†æ¶ï¼Œé‰´äºä¹‹å‰ä½¿ç”¨Eggæ¨¡ç‰ˆå¼•æ“<code>Nunjucks</code>åœ¨å†™H5é¡µå’ŒAMPé¡µçš„æ—¶å€™HTMLå’ŒCSSéƒ½éœ€è¦åˆ†å¼€å†™&amp;&amp;æ‰“åŒ…ï¼Œæ—¢ç„¶Nextæ”¯æŒAMPï¼Œä¸ºäº†ä½“ç°é‡æ„çš„ä»·å€¼äº‰å–ç”¨æœ€å°‘çš„ä»£ç å®ç°ä¸€æ­¥åˆ°ä½</li>
</ul>
<p>å¤§æ¦‚å°±æ˜¯è¿™ä¸‰ç‚¹æ˜¯æ•´ä¸ªæ­å»ºè¿‡ç¨‹éœ€è¦è€ƒè™‘çš„</p>
<h2 id="Egg-js-Next-js-Initialize-Combine"><a href="#Egg-js-Next-js-Initialize-Combine" class="headerlink" title="Egg.js+Next.js Initialize Combine"></a>Egg.js+Next.js Initialize Combine</h2><p>é¦–å…ˆä½¿ç”¨eggè„šæ‰‹æ¶åˆå§‹åŒ–é¡¹ç›®</p>
<blockquote>
<p>egg-init [project] â€“type=simple</p>
</blockquote>
<p>æŒ‰ä¸Šé¢è¯´çš„åˆ°çš„æ€è·¯åœ¨Eggå¯åŠ¨çš„æ—¶å€™å¯¹Nextè¿›è¡Œå®ä¾‹åŒ–ï¼Œé‚£ä¹ˆå…ˆæ¥å»ºä¸€ä¸ª<code>ssr.js</code>ï¼Œå¯¹<code>next</code>çš„å®ä¾‹åŒ–ä¸»è¦åˆ†ä¸º3æ­¥ï¼š</p>
<ul>
<li><code>next</code>å®ä¾‹åŒ–ï¼Œç„¶åè°ƒç”¨<code>prepare</code>æ–¹æ³•</li>
<li>å› ä¸ºéœ€è¦é€šè¿‡<code>next</code>ç”Ÿæˆ<code>htmlæ¨¡ç‰ˆ</code>ï¼Œå·²ç»ä¸éœ€è¦ä½¿ç”¨Eggçš„<code>render</code>æ–¹æ³•ï¼Œæ‰€ä»¥è¦è‡ªè¡Œå°è£…<code>renderTsx</code>æ–¹æ³•ï¼Œæ–¹æ³•å†…éƒ¨è°ƒç”¨<code>render</code>æ–¹æ³•è¿”å›æ¸²æŸ“å¥½çš„<code>htmlæ¨¡ç‰ˆ</code></li>
<li>ç„¶åæŠŠ<code>renderTsx</code>æ–¹æ³•æŒ‚è½½åˆ°Eggçš„<code>ctx</code>ä¸Š</li>
</ul>
<blockquote>
</blockquote>
<blockquote>
<p>server/ssr.ts</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Application&#125; <span class="keyword">from</span> <span class="string">'egg'</span></span><br><span class="line"><span class="keyword">const</span> next = <span class="built_in">require</span>(<span class="string">'next'</span>)</span><br><span class="line"><span class="keyword">const</span> dev = process.env.NODE_ENV !== <span class="string">'production'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">async</span> (app:Application) =&gt; &#123;</span><br><span class="line">  <span class="comment">// nextå®ä¾‹åŒ–</span></span><br><span class="line">  <span class="keyword">const</span> nextServer = next(&#123; dev &#125;);</span><br><span class="line">  <span class="comment">// ç¼“å­˜getRequestHanderæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">const</span> requestHandler = nextServer.getRequestHandler();</span><br><span class="line">  <span class="comment">// æŒ‰ç…§ä¸Šé¢åˆ†æå…ˆè°ƒç”¨prepareæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">await</span> nextServer.prepare();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> renderTsx = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = <span class="keyword">this</span>;</span><br><span class="line">      <span class="comment">// è°ƒç”¨nextServerçš„renderæ–¹æ³•ï¼Œé‡Œé¢ä¼ å…¥çš„pageè·¯å¾„å’Œå‚æ•°éƒ½é€šè¿‡åœ¨Eggç«¯ä¼ å…¥</span></span><br><span class="line">      <span class="keyword">const</span> html = <span class="keyword">await</span> nextServer.render(</span><br><span class="line">          ctx.req,</span><br><span class="line">          ctx.res,</span><br><span class="line">          <span class="string">`/<span class="subst">$&#123;options.page&#125;</span>`</span>,</span><br><span class="line">          options.props</span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// æ¨¡ç‰ˆæŒ‚è½½åˆ°bodyä¸Š</span></span><br><span class="line">      ctx.body = html;</span><br><span class="line">      <span class="keyword">return</span> html</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨Object.defineProertyæ–¹æ³•æŒ‚è½½renderTsxæ–¹æ³•</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(app.context, <span class="string">'renderTsx'</span>, &#123;</span><br><span class="line">      writable: <span class="literal">false</span>,</span><br><span class="line">      configurable: <span class="literal">false</span>,</span><br><span class="line">      value: renderTsx</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨Object.defineProertyæ–¹æ³•æŒ‚è½½requestHandleræ–¹æ³•ï¼Œåœ¨Eggä¸­é—´ä»¶è°ƒç”¨</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(app.context, <span class="string">'requestHandler'</span>, &#123;</span><br><span class="line">      writable: <span class="literal">false</span>,</span><br><span class="line">      configurable: <span class="literal">false</span>,</span><br><span class="line">      value: requestHandler</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®Egg.jsæ–‡æ¡£è‡ªå®šä¹‰EggæœåŠ¡éœ€è¦åœ¨æ ¹ç›®å½•å»ºä¸€ä¸ª<code>app.ts</code>ï¼Œå¹¶è¦é»˜è®¤å¯¼å‡ºä¸€ä¸ªç±»ï¼Œç„¶åå¼•å…¥åˆšæ‰åœ¨<code>ssr.ts</code>ä¸­å°è£…çš„å¯åŠ¨å‡½æ•°</p>
<blockquote>
<p>app.ts</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Application &#125; <span class="keyword">from</span> <span class="string">'egg'</span></span><br><span class="line"><span class="keyword">const</span> SSR = <span class="built_in">require</span>(<span class="string">'./server/ssr'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">app:Application</span>) =&gt;</span> &#123;</span><br><span class="line">    app.beforeStart(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">       <span class="keyword">await</span> SSR(app)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¯´åˆ°<code>requestHandler</code>åœ¨æŒ‚è½½åˆ°<code>ctx</code>ä¸Šåéœ€è¦åœ¨ä¸­é—´ä»¶è°ƒç”¨ï¼Œä¸ºä»€ä¹ˆè¦åœ¨ä¸­é—´ä»¶è°ƒç”¨å‘¢ï¼Œ</p>
<p>é€šè¿‡é˜…è¯»Nextçš„æºç åˆ†æäº†<code>getRequestHandler</code>è°ƒç”¨çš„å…¨è¿‡ç¨‹ï¼Œç®€å•æ€»ç»“ä¸‹è°ƒç”¨çš„è¿‡ç¨‹å¤§æ¦‚æ˜¯ï¼š</p>
<ul>
<li>Nextåœ¨å¯åŠ¨NodeæœåŠ¡<code>createServer</code>åä¼šè°ƒç”¨<code>getRequestHandler</code></li>
<li>è°ƒç”¨åæˆªå–å…¨éƒ¨è¯·æ±‚URL(è¿™ä¸ªURLä¸å•æŒ‡åªåœ¨æµè§ˆå™¨è¾“å…¥çš„ï¼Œè¿˜åŒ…æ‹¬å…¶ä»–é™æ€è„šæœ¬æ–‡ä»¶)ï¼ŒåŒæ—¶ä¸å†…éƒ¨çš„<code>Router</code>æ•°ç»„åšä¸€æ¬¡åŒ¹é…</li>
<li>å¦‚æœåŒ¹é…åˆ°å¯¹åº”çš„å‰ç¼€æ¯”å¦‚<code>/_next/static/</code>åä¼šå›è°ƒ<code>Router</code>ä¸­çš„<code>fn</code>æ–¹æ³•ï¼Œè€Œè¿™ä¸ª<code>fn</code>åšçš„äº‹æƒ…ä¸é™äºæ¸²æŸ“é¡µé¢ã€é¡µé¢çƒ­æ›´æ›¿ç­‰ç­‰</li>
</ul>
<p>æ—¢ç„¶è¦æˆªå–å…¨éƒ¨è¯·æ±‚URLé‚£æ”¾åœ¨ä¸­é—´ä»¶å°±å†é€‚åˆä¸è¿‡äº†ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦æ‰‹åŠ¨æŒ‚è½½åˆ°Eggçš„ä¸­é—´ä»¶ä¸Šï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰å¯åŠ¨Nextå†…éƒ¨çš„NodeæœåŠ¡ï¼Œæ‰€ä»¥è¦æ‰‹åŠ¨è°ƒç”¨æŒ‚è½½è¿™ä¸ªæ–¹æ³•</p>
<blockquote>
<p>middleware/next.ts</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Application &#125; <span class="keyword">from</span> <span class="string">'egg'</span></span><br><span class="line"><span class="keyword">const</span> &#123; parse &#125; = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">app: Application</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> isNextStatic = <span class="regexp">/\/_next\//</span>.test(ctx.url)</span><br><span class="line">        <span class="keyword">if</span> (isNextStatic) &#123;</span><br><span class="line">            <span class="keyword">const</span> reqeustUrl = parse(ctx.url, <span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">await</span> ctx.requestHandler(ctx.req, ctx.res, reqeustUrl)</span><br><span class="line">        &#125; &#123;</span><br><span class="line">            <span class="keyword">await</span> next()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨<code>config</code>æ–‡ä»¶å¤¹ä¸­é…ç½®<code>config.default.ts</code>æ–‡ä»¶ï¼Œé»˜è®¤å¼€å¯ä¸­é—´ä»¶</p>
<blockquote>
<p>config/config.default.ts</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">appInfo: EggAppInfo</span>) =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  config.middleware = [<span class="string">'next'</span>]</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> &#123; ...config &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>çœ‹åˆ°è¿™é‡Œçœ‹å®˜ä»¬åº”è¯¥ä¼šæœ‰ä¸€ä¸ªç–‘é—®ğŸ¤”ï¸ï¼Œä¸ºä»€ä¹ˆeggçš„è‡ªå®šä¹‰é…ç½®ç”¨çš„æ˜¯<code>common.js</code>è§„èŒƒè€Œä¸æ˜¯<code>esmodule</code>è§„èŒƒï¼Œåœ¨æˆ‘çš„<a href="https://biaodigit.github.io/2020/01/07/2/" target="_blank" rel="noopener">Next.jsä½¿ç”¨æ€»ç»“</a>æ–‡ç« ä¸­æœ‰æ€»ç»“åŸå› ï¼Œåœ¨è¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œæ¬¢è¿å„ä½çœ‹å®˜å»çœ‹ä¸€çœ‹ï¼Œè¯´ä¸å®šè¿˜æœ‰ä¸€äº›ä½ ç°åœ¨ä½¿ç”¨Next.jsçš„ä¸€äº›ç–‘éš¾æ‚ç—‡ï¼ˆæ‰‹åŠ¨æ–œçœ¼ã€‚</p>
<p>è‡³æ­¤Next.js+Egg.jsé…ç½®å·²åŸºæœ¬ç»“æŸï¼Œæ¥¼ä¸»è¿˜æ˜¯ä¼šä¸€ç›´æŒç»­å…³æ³¨Next.jsçš„å˜åŒ–ï¼Œé¡ºä¾¿å†™ä¸€äº›Next.jsæºç è§£ææ–‡ç« ï¼Œæ¯•ç«Ÿå·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨ï¼Œçµæ´»è¿ç”¨ä¸€ä¸ªæ¡†æ¶äº†è§£å…¶åŸç†æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œæ‰€ä»¥æ•¬è¯·æœŸå¾…ğŸ‰ğŸ‰ğŸ‰</p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/01/18/4/" class="prev">PREV</a><a href="/2020/01/07/2/" class="next">NEXT</a></div><div class="copyright"><p>Â© 2015 - 2020 <a href="http://yoursite.com">biaodigit</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>