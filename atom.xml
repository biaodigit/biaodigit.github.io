<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç½—æ–‡è¿ªçš„åšå®¢</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-03-02T08:12:17.012Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>biaodigit</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Next.jsæºç è§£æâ€”â€”â€”â€”å¯åŠ¨å‘½ä»¤ç¯‡</title>
    <link href="http://yoursite.com/2020/01/18/4/"/>
    <id>http://yoursite.com/2020/01/18/4/</id>
    <published>2020-01-18T01:45:54.000Z</published>
    <updated>2020-03-02T08:12:17.012Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Next.js</p><a id="more"></a>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;Next.js&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Next.js+Egg.jsé…ç½®</title>
    <link href="http://yoursite.com/2020/01/07/3/"/>
    <id>http://yoursite.com/2020/01/07/3/</id>
    <published>2020-01-07T14:01:19.000Z</published>
    <updated>2020-03-02T08:19:12.380Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Next-jsç®€ä»‹"><a href="#Next-jsç®€ä»‹" class="headerlink" title="Next.jsç®€ä»‹"></a>Next.jsç®€ä»‹</h2><p>Next.jsä½œä¸º<a href="https://reactjs.org/docs/create-a-new-react-app.html#nextjs" target="_blank" rel="noopener">Reactå®˜æ–¹é’¦å®š</a>çš„SSRè½»é‡çº§æ¡†æ¶ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p><ul><li>å¼€ç®±å³ç”¨ï¼Œæ”¯æŒ0é…ç½®å¼€å‘</li><li>æ”¯æŒçº¦å®šå¼è·¯ç”±</li><li>æ”¯æŒè‡ªå®šä¹‰æœåŠ¡ç«¯è·¯ç”±ï¼Œå¯ä»¥é…åˆå…¶ä»–Nodeæ¡†æ¶ä½¿ç”¨</li><li>æ¸è¿›å¼babelå’Œwebpacké…ç½®</li><li>æ”¯æŒå®¢æˆ·ç«¯æ¸²æŸ“</li><li>ç¤¾åŒºæ´»è·ƒï¼Œå›¢é˜Ÿä¸å¤ªç›‘</li><li>å¯¹å‰ç«¯æ–°æŠ€æœ¯æ”¯æŒè¾ƒä¸ºå…¨é¢ï¼Œæ¯”å¦‚AMPã€TypeScriptã€PWAã€Serverlessç­‰</li></ul><p>åœ¨Nemo FEä»¥Reactä¸ºä¸»è¦å¼€å‘æ¡†æ¶çš„å‰æä¸‹SEOé¡¹ç›®é‡æ„é€‰æ‹©Next.jså°±éå¸¸åˆé€‚</p><a id="more"></a><h2 id="Next-jsè‡ªå®šä¹‰é…ç½®"><a href="#Next-jsè‡ªå®šä¹‰é…ç½®" class="headerlink" title="Next.jsè‡ªå®šä¹‰é…ç½®"></a>Next.jsè‡ªå®šä¹‰é…ç½®</h2><p>å®˜æ–¹æ–‡æ¡£åœ¨è‡ªå®šä¹‰æœåŠ¡ç«¯è·¯ç”±çš„ä¾‹å­ä¸­ç»™å‡ºäº†ä¸€ä¸ªdemoï¼Œå¯ä»¥ç»™åé¢å’ŒEgg.jsé…ç½®æä¾›å‚è€ƒæ€§</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createServer &#125; = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; parse &#125; = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"><span class="keyword">const</span> next = <span class="built_in">require</span>(<span class="string">'next'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dev = process.env.NODE_ENV !== <span class="string">'production'</span></span><br><span class="line"><span class="keyword">const</span> app = next(&#123; dev &#125;)</span><br><span class="line"><span class="keyword">const</span> handle = app.getRequestHandler()</span><br><span class="line"></span><br><span class="line">app.prepare().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> parsedUrl = parse(req.url, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> &#123; pathname, query &#125; = parsedUrl</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pathname === <span class="string">'/a'</span>) &#123;</span><br><span class="line">      app.render(req, res, <span class="string">'/b'</span>, query)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pathname === <span class="string">'/b'</span>) &#123;</span><br><span class="line">      app.render(req, res, <span class="string">'/a'</span>, query)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      handle(req, res, parsedUrl)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).listen(<span class="number">3000</span>, err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'&gt; Ready on http://localhost:3000'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å¤§æ¦‚å¯ä»¥æ‹†åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†:<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dev = process.env.NODE_ENV !== <span class="string">'production'</span></span><br><span class="line"><span class="keyword">const</span> app = next(&#123; dev &#125;)</span><br><span class="line"><span class="keyword">const</span> handle = app.getRequestHandler()</span><br></pre></td></tr></table></figure><p>1.å¯¹nextè¿›è¡Œå®ä¾‹åŒ–ï¼Œç¼“å­˜ç¯å¢ƒå˜é‡ä»¥åŠä¸€ä¸ªå¤„ç†é¡µé¢èµ„æºè¯·æ±‚çš„æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.prepare().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>2.å½“å‰æœŸçš„å®ä¾‹å’Œæ–¹æ³•éƒ½å‡†å¤‡å¥½ä»¥åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å¯åŠ¨æœåŠ¡äº†ï¼Œå¯åŠ¨httpæœåŠ¡ä¹‹å‰å…ˆè·‘äº†ä¸€æ¬¡<code>app.prepare</code>ï¼Œè€Œè¿™ä¸ª<code>app.prepare</code>æ˜¯å¹²ä»€ä¹ˆç”¨çš„å‘¢ï¼Œåœ¨è¿™é‡Œå¯ä»¥å…ˆä¸æ€¥ç€å»çœ‹prepareçš„æºç ï¼Œå¯ä»¥å…ˆå»çœ‹çœ‹nextå®˜æ–¹è„šæ‰‹æ¶æ˜¯æ€ä¹ˆè·‘èµ·æ¥çš„ã€‚</p><p>å®˜æ–¹ç»™å‡ºçš„å‘½ä»¤é…ç½®å¦‚ä¸‹ï¼š<br><img src="/2020/01/07/3/01.png" alt="01.png"><br>ä»¥<code>dev</code>ä¸ºä¾‹ï¼Œå¯ä»¥ä»nextæºç ä¸­æ‰¾åˆ°å¯¹åº”çš„<code>cli/next-dev.ts</code>æ–‡ä»¶</p><blockquote><p>next-dev.ts</p></blockquote><p><img src="/2020/01/07/3/02.png" alt="02.png"><br>å¯ä»¥çœ‹åˆ°åœ¨<code>dev</code>å¯åŠ¨å‘½ä»¤åŒæ ·è°ƒç”¨äº†<code>app.prepare</code>è¿™ä¸ªæ–¹æ³•ï¼Œè€Œå‰é¢é‚£ä¸ª<code>startServer</code>åˆæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œå¯ä»¥æ ¹æ®è·¯å¾„æ‰¾åˆ°å¯¹åº”æ–‡ä»¶</p><blockquote><p>start-server.ts</p></blockquote><p><img src="/2020/01/07/3/03.png" alt="03.png"></p><p>çœ‹åˆ°è¿™é‡Œå°±å¤§æ¦‚çŸ¥é“å®˜æ–¹å¯åŠ¨nextçš„æµç¨‹æ˜¯å…ˆå¯åŠ¨ä¸€ä¸ªhttpæœåŠ¡ï¼Œå¯åŠ¨å®Œåå†å»è°ƒç”¨<code>app.prepare</code>æ–¹æ³•ï¼Œé™¤äº†<code>dev</code>ç”Ÿäº§æ¨¡å¼ä¸‹çš„<code>start</code>ä¹Ÿæ˜¯åŒæ ·æµç¨‹ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™prepareå†…éƒ¨æ˜¯å¹²ä»€ä¹ˆçš„å·²ç»ä¸éœ€è¦å»çŸ¥é“ï¼Œæºç æ€ä¹ˆåšè¿™è¾¹è‡ªå®šä¹‰å¯åŠ¨nextå°±æ€ä¹ˆåš</p><p>è‡³äºæ˜¯å…ˆåˆ›å»ºhttpæœåŠ¡è¿˜æ˜¯å…ˆè·‘<code>app.prepare</code>æ–¹æ³•ä¹Ÿä¸é‡è¦ï¼Œåªè¦åœ¨å¼€å§‹åšè·¯ç”±åŒ¹é…å‰éƒ½å¯åŠ¨å®Œæˆå³å¯</p><h2 id="Egg-jsè‡ªå®šä¹‰é…ç½®"><a href="#Egg-jsè‡ªå®šä¹‰é…ç½®" class="headerlink" title="Egg.jsè‡ªå®šä¹‰é…ç½®"></a>Egg.jsè‡ªå®šä¹‰é…ç½®</h2><p>Egg.jsè‡ªå®šä¹‰é…ç½®è¾ƒç®€å•ï¼Œåªéœ€è¦åœ¨æ ¹ç›®å½•æ–°å»ºä¸€ä¸ª<code>app.js</code>ï¼Œè°ƒç”¨<code>beforeStart</code>å³å¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (app) =&gt; &#123;</span><br><span class="line">    app.beforeStart(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">       ...      </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>beforeStart</code>å®šä¹‰</p><blockquote><p>æ‰€æœ‰çš„é…ç½®å·²ç»åŠ è½½å®Œæ¯•,å¯ä»¥ç”¨æ¥åŠ è½½åº”ç”¨è‡ªå®šä¹‰çš„æ–‡ä»¶ï¼Œå¯åŠ¨è‡ªå®šä¹‰çš„æœåŠ¡</p></blockquote><h2 id="æ­å»ºæ€è·¯"><a href="#æ­å»ºæ€è·¯" class="headerlink" title="æ­å»ºæ€è·¯"></a>æ­å»ºæ€è·¯</h2><blockquote><p>æœ¬æ–‡é‡‡ç”¨çš„Next9.xç‰ˆæœ¬è¿›è¡Œé…ç½®ï¼Œå·²æˆåŠŸè¿›è¡Œä¸Šçº¿éªŒè¯</p></blockquote><p>Okï¼Œåœ¨åˆ†æå®ŒNext.jså’ŒEgg.jsçš„è‡ªå®šä¹‰é…ç½®è¿‡ç¨‹åï¼Œä¸‹é¢å¼€å§‹æ€è€ƒä¸‹ğŸ¤”æ€ä¹ˆæŠŠè¿™ä¸¤ä¸ªå®˜æ–¹å›¢é˜Ÿç›¸äº’æ’æ–¥çš„æ¡†æ¶ç»“åˆåœ¨ä¸€èµ·åšæˆè‡ªå·±æƒ³è¦çš„é…ç½®</p><p>å…ˆæ‹ä¸€ä¸‹æ­å»ºæ€è·¯ï¼š</p><ul><li>é¦–å…ˆè·¯ç”±æ˜¯ç”±Eggæ§åˆ¶è€Œä¸æ˜¯ä½¿ç”¨Nextçš„çº¦å®šå¼è·¯ç”±ï¼Œå› ä¸ºå¥‘åˆSEOéœ€æ±‚ä¸€ä¸ªé¡µé¢å¯èƒ½è¢«å¤šä¸ªè·¯ç”±ä½¿ç”¨ï¼Œæ‰€ä»¥ç”¨Eggæ§åˆ¶è·¯ç”±æ›´åˆé€‚</li><li>æ—¢ç„¶é¡¹ç›®ç”¨Eggå¯åŠ¨ä¹Ÿå°±æ˜¯Nextéœ€è¦è‡ªå®šä¹‰åœ¨Eggå¯åŠ¨çš„æ—¶å€™å®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–è¦åšä¸¤ä»¶äº‹æƒ…ï¼š<ul><li>1.è‡ªå®šä¹‰ä¸€ä¸ªrenderæ–¹æ³•ç„¶åæŒ‚è½½åœ¨ä¸ŠEggä¸Šï¼Œå› ä¸ºViewå±‚æ¸²æŸ“æ˜¯ç”±Nextå»å®Œæˆï¼Œç„¶åé€šè¿‡çš„Eggçš„Controllerè¿”å›ç»™å®¢æˆ·ç«¯</li><li>2.ä¸Šæ–‡æåˆ°Nextæœ‰ä¸€ä¸ª<code>getRequestHandler</code>çš„æ–¹æ³•ç”¨äºå¤„ç†è·¯ç”±å’Œé™æ€æ–‡ä»¶ï¼Œæ”¾åˆ°è¿™é‡Œè·¯ç”±æ˜¯ä¸ç”¨å¤„ç†å› ä¸ºè¿™äº‹æ˜¯Eggåšçš„ï¼Œä½†æ˜¯é™æ€èµ„æºè¿˜æ˜¯è¦ç”±Nextåšçš„ï¼Œæ‰€ä»¥ä¹Ÿåº”è¯¥æƒ³åŠæ³•æŠŠè¿™ä¸ªæ–¹æ³•æŒ‚åˆ°Eggä¸Š</li></ul></li><li>è€ƒè™‘åˆ°SEOéœ€æ±‚éœ€è¦ä½¿ç”¨Googleçš„<code>AMP</code>æ¡†æ¶ï¼Œé‰´äºä¹‹å‰ä½¿ç”¨Eggæ¨¡ç‰ˆå¼•æ“<code>Nunjucks</code>åœ¨å†™H5é¡µå’ŒAMPé¡µçš„æ—¶å€™HTMLå’ŒCSSéƒ½éœ€è¦åˆ†å¼€å†™&amp;&amp;æ‰“åŒ…ï¼Œæ—¢ç„¶Nextæ”¯æŒAMPï¼Œä¸ºäº†ä½“ç°é‡æ„çš„ä»·å€¼äº‰å–ç”¨æœ€å°‘çš„ä»£ç å®ç°ä¸€æ­¥åˆ°ä½</li></ul><p>å¤§æ¦‚å°±æ˜¯è¿™ä¸‰ç‚¹æ˜¯æ•´ä¸ªæ­å»ºè¿‡ç¨‹éœ€è¦è€ƒè™‘çš„</p><h2 id="Egg-js-Next-js-Initialize-Combine"><a href="#Egg-js-Next-js-Initialize-Combine" class="headerlink" title="Egg.js+Next.js Initialize Combine"></a>Egg.js+Next.js Initialize Combine</h2><p>é¦–å…ˆä½¿ç”¨eggè„šæ‰‹æ¶åˆå§‹åŒ–é¡¹ç›®</p><blockquote><p>egg-init [project] â€“type=simple</p></blockquote><p>æŒ‰ä¸Šé¢è¯´çš„åˆ°çš„æ€è·¯åœ¨Eggå¯åŠ¨çš„æ—¶å€™å¯¹Nextè¿›è¡Œå®ä¾‹åŒ–ï¼Œé‚£ä¹ˆå…ˆæ¥å»ºä¸€ä¸ª<code>ssr.js</code>ï¼Œå¯¹<code>next</code>çš„å®ä¾‹åŒ–ä¸»è¦åˆ†ä¸º3æ­¥ï¼š</p><ul><li><code>next</code>å®ä¾‹åŒ–ï¼Œç„¶åè°ƒç”¨<code>prepare</code>æ–¹æ³•</li><li>å› ä¸ºéœ€è¦é€šè¿‡<code>next</code>ç”Ÿæˆ<code>htmlæ¨¡ç‰ˆ</code>ï¼Œå·²ç»ä¸éœ€è¦ä½¿ç”¨Eggçš„<code>render</code>æ–¹æ³•ï¼Œæ‰€ä»¥è¦è‡ªè¡Œå°è£…<code>renderTsx</code>æ–¹æ³•ï¼Œæ–¹æ³•å†…éƒ¨è°ƒç”¨<code>render</code>æ–¹æ³•è¿”å›æ¸²æŸ“å¥½çš„<code>htmlæ¨¡ç‰ˆ</code></li><li>ç„¶åæŠŠ<code>renderTsx</code>æ–¹æ³•æŒ‚è½½åˆ°Eggçš„<code>ctx</code>ä¸Š</li></ul><blockquote></blockquote><blockquote><p>server/ssr.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Application&#125; <span class="keyword">from</span> <span class="string">'egg'</span></span><br><span class="line"><span class="keyword">const</span> next = <span class="built_in">require</span>(<span class="string">'next'</span>)</span><br><span class="line"><span class="keyword">const</span> dev = process.env.NODE_ENV !== <span class="string">'production'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">async</span> (app:Application) =&gt; &#123;</span><br><span class="line">  <span class="comment">// nextå®ä¾‹åŒ–</span></span><br><span class="line">  <span class="keyword">const</span> nextServer = next(&#123; dev &#125;);</span><br><span class="line">  <span class="comment">// ç¼“å­˜getRequestHanderæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">const</span> requestHandler = nextServer.getRequestHandler();</span><br><span class="line">  <span class="comment">// æŒ‰ç…§ä¸Šé¢åˆ†æå…ˆè°ƒç”¨prepareæ–¹æ³•</span></span><br><span class="line">  <span class="keyword">await</span> nextServer.prepare();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> renderTsx = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">options</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> ctx = <span class="keyword">this</span>;</span><br><span class="line">      <span class="comment">// è°ƒç”¨nextServerçš„renderæ–¹æ³•ï¼Œé‡Œé¢ä¼ å…¥çš„pageè·¯å¾„å’Œå‚æ•°éƒ½é€šè¿‡åœ¨Eggç«¯ä¼ å…¥</span></span><br><span class="line">      <span class="keyword">const</span> html = <span class="keyword">await</span> nextServer.render(</span><br><span class="line">          ctx.req,</span><br><span class="line">          ctx.res,</span><br><span class="line">          <span class="string">`/<span class="subst">$&#123;options.page&#125;</span>`</span>,</span><br><span class="line">          options.props</span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// æ¨¡ç‰ˆæŒ‚è½½åˆ°bodyä¸Š</span></span><br><span class="line">      ctx.body = html;</span><br><span class="line">      <span class="keyword">return</span> html</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨Object.defineProertyæ–¹æ³•æŒ‚è½½renderTsxæ–¹æ³•</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(app.context, <span class="string">'renderTsx'</span>, &#123;</span><br><span class="line">      writable: <span class="literal">false</span>,</span><br><span class="line">      configurable: <span class="literal">false</span>,</span><br><span class="line">      value: renderTsx</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿ç”¨Object.defineProertyæ–¹æ³•æŒ‚è½½requestHandleræ–¹æ³•ï¼Œåœ¨Eggä¸­é—´ä»¶è°ƒç”¨</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(app.context, <span class="string">'requestHandler'</span>, &#123;</span><br><span class="line">      writable: <span class="literal">false</span>,</span><br><span class="line">      configurable: <span class="literal">false</span>,</span><br><span class="line">      value: requestHandler</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®Egg.jsæ–‡æ¡£è‡ªå®šä¹‰EggæœåŠ¡éœ€è¦åœ¨æ ¹ç›®å½•å»ºä¸€ä¸ª<code>app.ts</code>ï¼Œå¹¶è¦é»˜è®¤å¯¼å‡ºä¸€ä¸ªç±»ï¼Œç„¶åå¼•å…¥åˆšæ‰åœ¨<code>ssr.ts</code>ä¸­å°è£…çš„å¯åŠ¨å‡½æ•°</p><blockquote><p>app.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Application &#125; <span class="keyword">from</span> <span class="string">'egg'</span></span><br><span class="line"><span class="keyword">const</span> SSR = <span class="built_in">require</span>(<span class="string">'./server/ssr'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">app:Application</span>) =&gt;</span> &#123;</span><br><span class="line">    app.beforeStart(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">       <span class="keyword">await</span> SSR(app)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¯´åˆ°<code>requestHandler</code>åœ¨æŒ‚è½½åˆ°<code>ctx</code>ä¸Šåéœ€è¦åœ¨ä¸­é—´ä»¶è°ƒç”¨ï¼Œä¸ºä»€ä¹ˆè¦åœ¨ä¸­é—´ä»¶è°ƒç”¨å‘¢ï¼Œ</p><p>é€šè¿‡é˜…è¯»Nextçš„æºç åˆ†æäº†<code>getRequestHandler</code>è°ƒç”¨çš„å…¨è¿‡ç¨‹ï¼Œç®€å•æ€»ç»“ä¸‹è°ƒç”¨çš„è¿‡ç¨‹å¤§æ¦‚æ˜¯ï¼š</p><ul><li>Nextåœ¨å¯åŠ¨NodeæœåŠ¡<code>createServer</code>åä¼šè°ƒç”¨<code>getRequestHandler</code></li><li>è°ƒç”¨åæˆªå–å…¨éƒ¨è¯·æ±‚URL(è¿™ä¸ªURLä¸å•æŒ‡åªåœ¨æµè§ˆå™¨è¾“å…¥çš„ï¼Œè¿˜åŒ…æ‹¬å…¶ä»–é™æ€è„šæœ¬æ–‡ä»¶)ï¼ŒåŒæ—¶ä¸å†…éƒ¨çš„<code>Router</code>æ•°ç»„åšä¸€æ¬¡åŒ¹é…</li><li>å¦‚æœåŒ¹é…åˆ°å¯¹åº”çš„å‰ç¼€æ¯”å¦‚<code>/_next/static/</code>åä¼šå›è°ƒ<code>Router</code>ä¸­çš„<code>fn</code>æ–¹æ³•ï¼Œè€Œè¿™ä¸ª<code>fn</code>åšçš„äº‹æƒ…ä¸é™äºæ¸²æŸ“é¡µé¢ã€é¡µé¢çƒ­æ›´æ›¿ç­‰ç­‰</li></ul><p>æ—¢ç„¶è¦æˆªå–å…¨éƒ¨è¯·æ±‚URLé‚£æ”¾åœ¨ä¸­é—´ä»¶å°±å†é€‚åˆä¸è¿‡äº†ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦æ‰‹åŠ¨æŒ‚è½½åˆ°Eggçš„ä¸­é—´ä»¶ä¸Šï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰å¯åŠ¨Nextå†…éƒ¨çš„NodeæœåŠ¡ï¼Œæ‰€ä»¥è¦æ‰‹åŠ¨è°ƒç”¨æŒ‚è½½è¿™ä¸ªæ–¹æ³•</p><blockquote><p>middleware/next.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Application &#125; <span class="keyword">from</span> <span class="string">'egg'</span></span><br><span class="line"><span class="keyword">const</span> &#123; parse &#125; = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">app: Application</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> isNextStatic = <span class="regexp">/\/_next\//</span>.test(ctx.url)</span><br><span class="line">        <span class="keyword">if</span> (isNextStatic) &#123;</span><br><span class="line">            <span class="keyword">const</span> reqeustUrl = parse(ctx.url, <span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">await</span> ctx.requestHandler(ctx.req, ctx.res, reqeustUrl)</span><br><span class="line">        &#125; &#123;</span><br><span class="line">            <span class="keyword">await</span> next()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨<code>config</code>æ–‡ä»¶å¤¹ä¸­é…ç½®<code>config.default.ts</code>æ–‡ä»¶ï¼Œé»˜è®¤å¼€å¯ä¸­é—´ä»¶</p><blockquote><p>config/config.default.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">appInfo: EggAppInfo</span>) =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  config.middleware = [<span class="string">'next'</span>]</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> &#123; ...config &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œçœ‹å®˜ä»¬åº”è¯¥ä¼šæœ‰ä¸€ä¸ªç–‘é—®ğŸ¤”ï¸ï¼Œä¸ºä»€ä¹ˆeggçš„è‡ªå®šä¹‰é…ç½®ç”¨çš„æ˜¯<code>common.js</code>è§„èŒƒè€Œä¸æ˜¯<code>esmodule</code>è§„èŒƒï¼Œåœ¨æˆ‘çš„<a href="https://biaodigit.github.io/2020/01/07/2/" target="_blank" rel="noopener">Next.jsä½¿ç”¨æ€»ç»“</a>æ–‡ç« ä¸­æœ‰æ€»ç»“åŸå› ï¼Œåœ¨è¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œæ¬¢è¿å„ä½çœ‹å®˜å»çœ‹ä¸€çœ‹ï¼Œè¯´ä¸å®šè¿˜æœ‰ä¸€äº›ä½ ç°åœ¨ä½¿ç”¨Next.jsçš„ä¸€äº›ç–‘éš¾æ‚ç—‡ï¼ˆæ‰‹åŠ¨æ–œçœ¼ã€‚</p><p>è‡³æ­¤Next.js+Egg.jsé…ç½®å·²åŸºæœ¬ç»“æŸï¼Œæ¥¼ä¸»è¿˜æ˜¯ä¼šä¸€ç›´æŒç»­å…³æ³¨Next.jsçš„å˜åŒ–ï¼Œé¡ºä¾¿å†™ä¸€äº›Next.jsæºç è§£ææ–‡ç« ï¼Œæ¯•ç«Ÿå·¥æ¬²å–„å…¶äº‹å¿…å…ˆåˆ©å…¶å™¨ï¼Œçµæ´»è¿ç”¨ä¸€ä¸ªæ¡†æ¶äº†è§£å…¶åŸç†æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œæ‰€ä»¥æ•¬è¯·æœŸå¾…ğŸ‰ğŸ‰ğŸ‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Next-jsç®€ä»‹&quot;&gt;&lt;a href=&quot;#Next-jsç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;Next.jsç®€ä»‹&quot;&gt;&lt;/a&gt;Next.jsç®€ä»‹&lt;/h2&gt;&lt;p&gt;Next.jsä½œä¸º&lt;a href=&quot;https://reactjs.org/docs/create-a-new-react-app.html#nextjs&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Reactå®˜æ–¹é’¦å®š&lt;/a&gt;çš„SSRè½»é‡çº§æ¡†æ¶ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¼€ç®±å³ç”¨ï¼Œæ”¯æŒ0é…ç½®å¼€å‘&lt;/li&gt;
&lt;li&gt;æ”¯æŒçº¦å®šå¼è·¯ç”±&lt;/li&gt;
&lt;li&gt;æ”¯æŒè‡ªå®šä¹‰æœåŠ¡ç«¯è·¯ç”±ï¼Œå¯ä»¥é…åˆå…¶ä»–Nodeæ¡†æ¶ä½¿ç”¨&lt;/li&gt;
&lt;li&gt;æ¸è¿›å¼babelå’Œwebpacké…ç½®&lt;/li&gt;
&lt;li&gt;æ”¯æŒå®¢æˆ·ç«¯æ¸²æŸ“&lt;/li&gt;
&lt;li&gt;ç¤¾åŒºæ´»è·ƒï¼Œå›¢é˜Ÿä¸å¤ªç›‘&lt;/li&gt;
&lt;li&gt;å¯¹å‰ç«¯æ–°æŠ€æœ¯æ”¯æŒè¾ƒä¸ºå…¨é¢ï¼Œæ¯”å¦‚AMPã€TypeScriptã€PWAã€Serverlessç­‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨Nemo FEä»¥Reactä¸ºä¸»è¦å¼€å‘æ¡†æ¶çš„å‰æä¸‹SEOé¡¹ç›®é‡æ„é€‰æ‹©Next.jså°±éå¸¸åˆé€‚&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Next.jsä½¿ç”¨æ€»ç»“</title>
    <link href="http://yoursite.com/2020/01/07/2/"/>
    <id>http://yoursite.com/2020/01/07/2/</id>
    <published>2020-01-07T13:28:09.000Z</published>
    <updated>2020-03-02T08:17:51.294Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬æ–‡ä¼šæ€»ç»“ä½¿ç”¨Next.jsåœ¨å…·ä½“ä¸šåŠ¡åœºæ™¯ä¸‹ç¢°åˆ°çš„ä¸€äº›å¤§å‘ä»¥åŠå…·ä½“è§£å†³æ–¹æ¡ˆï¼Œåœ¨å¼€å§‹æ€»ç»“å‰å…ˆè¡¨è¾¾ä¸‹å¯¹ZEITå›¢é˜Ÿçš„æ•¬ä½©ï¼Œæ„Ÿè°¢ğŸ™ä»–ä»¬å¼€æºå‡ºä¸€æ¬¾ä¼˜ç§€çš„åŒæ„æ¡†æ¶ï¼Œè§£æ•‘äº†æ›¾ç»è›‹ç–¼çš„é™·åœ¨ä½¿ç”¨æ¨¡ç‰ˆå¼•æ“åšSSRé¡¹ç›®çš„å¼€å‘è€…(æ¯”å¦‚æˆ‘)ï¼Œé€šè¿‡Next.jsé‡æ„åçš„é¡¹ç›®æ›´åŠ è½»é‡åŒ–ï¼Œæ€§èƒ½ä¸Šä¹Ÿæœ‰å¤§å¹…åº¦çš„æå‡ï¼Œå¦‚ä¸‹å›¾</p><a id="more"></a><p><strong>é‡æ„å‰</strong>ï¼š<br><img src="/2020/01/07/2/01.png" alt="01.png"><br><strong>é‡æ„å</strong>ï¼š<br><img src="/2020/01/07/2/02.png" alt="02.png"></p><p>æ€§èƒ½æ•°æ®æ˜¯é€šè¿‡ABTestä½¿ç”¨å¼€æºçš„<a href="https://github.com/WarrenJones/nemetric" target="_blank" rel="noopener">Nemetric</a>æŠ“å–<code>FetchTime</code>å’Œ<code>FirstContentfulPaint</code>ä¸¤ä¸ªæ€§èƒ½æŒ‡æ ‡ï¼Œç„¶åä¼ åˆ°kibanaä¸Šå¯¹æ¯”ï¼Œå¯¹æ¯”åçš„æ€§èƒ½æ•°æ®åœ¨ä¸åŒçº¬åº¦ä¸‹æå‡<strong>20%-30%</strong>ï¼Œè¿™é‡Œå¤šæä¸€å¥å¯èƒ½å¾ˆå¤šäººå¯¹ä¼˜åŒ–åçš„æ•ˆæœå¾ˆéš¾æ„ŸçŸ¥åˆ°ï¼Œæˆ–è€…ä¼˜åŒ–çš„ä»·å€¼åœ¨å“ªï¼Œä½†å®é™…ä¸Šæ ¹æ®è°·æ­Œå‘å¸ƒçš„<a href="https://developers.google.com/web/fundamentals/performance/why-performance-matters" target="_blank" rel="noopener">æ€§èƒ½ä¸ºä½•è‡³å…³é‡è¦</a>ï¼ŒçœŸçš„æ˜¯ä¸€å¯¸å…‰é˜´ä¸€å¯¸é‡‘ï¼Œæ‰€ä»¥åœ¨çœ‹åˆ°è¿™ä¸ªæ•°æ®å¯¹æ¯”åæˆ‘çš„æ„Ÿè§‰å°±æ˜¯ï¼š</p><img src="/2020/01/07/2/04.gif"><p>å‰è¨€è®²å®Œï¼Œå°±å¼€å§‹è®²è®²ç¢°åˆ°çš„å‘äº†</p><h2 id="ä¸Egg-jsç»“åˆä½¿ç”¨"><a href="#ä¸Egg-jsç»“åˆä½¿ç”¨" class="headerlink" title="ä¸Egg.jsç»“åˆä½¿ç”¨"></a>ä¸Egg.jsç»“åˆä½¿ç”¨</h2><p>Next.jså®˜æ–¹githubæœ‰ä¸€ä¸ªexample libraryï¼Œé‡Œé¢ä¸»è¦æ˜¯Next.jsä¸å…¶ä»–æŠ€æœ¯ç»“åˆä½¿ç”¨çš„ä¸€äº›demoï¼Œä½†æ²¡æœ‰ä¸Egg.jsç»“åˆçš„ä¾‹å­ï¼Œè€Œåœ¨Egg.jså®˜æ–¹githubæœ‰äººæè¿‡<a href="https://github.com/eggjs/egg/issues/3393" target="_blank" rel="noopener">issue</a>Egg.jsæ€æ ·å»æ¥å…¥Next.jsï¼Œå®˜æ–¹ç»™å‡ºçš„ç­”å¤æ˜¯Koa/Eggçš„åº•å±‚å®ç°ä¸åŸºäºExpresså®ç°çš„Nextæœ‰å†²çªï¼Œä¸å»ºè®®ä¸¤è€…ç»“åˆä½¿ç”¨ã€‚æ‰€ä»¥ç½‘ä¸Šå¯¹å¦‚ä½•æŠŠEgg.jså’ŒNext.jsä¸€èµ·ä½¿ç”¨çš„èµ„æ–™æ¯”è¾ƒç¨€ç¼º</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>:<br><a href="https://biaodigit.github.io/2020/01/07/3/" target="_blank" rel="noopener">Next.js+Egg.jsé…ç½®</a></p><p>ä¸Šé¢çš„æ­å»ºé…ç½®æ˜¯ç»é˜…è¯»äº†ä¸€ç‚¹Next.jsæºç æ¢ç´¢å‡ºæ¥çš„ï¼Œç°åœ¨å·²ç»å¯ä»¥å®Œæ•´æ”¯æŒæˆ‘å¸10ä¸‡DAUçš„æ¨å¹¿é¡µæ­£å¸¸è¿è¡Œã€‚</p><h2 id="æŒ‰é¡µé¢åˆ†å‰²æ ·å¼"><a href="#æŒ‰é¡µé¢åˆ†å‰²æ ·å¼" class="headerlink" title="æŒ‰é¡µé¢åˆ†å‰²æ ·å¼"></a>æŒ‰é¡µé¢åˆ†å‰²æ ·å¼</h2><p>åœ¨å¼€å‘çš„æ—¶å€™ç”±äºVidMate Sitesæ˜¯å¤šé¡µåº”ç”¨ï¼ŒæŒ‰é¢„æœŸæ˜¯æ¯ä¸ªé¡µé¢åªéœ€è¦åŠ è½½å¯¹åº”é¡µé¢çš„cssæ–‡ä»¶å’Œå…¬å…±cssæ–‡ä»¶ï¼Œä½†æ˜¯æŸ¥çœ‹networkçš„æ—¶å€™å‘ç°æ¯ä¸€ä¸ªé¡µé¢éƒ½æ˜¯åŠ è½½åŒä¸€ä¸ªstyles.cssæ–‡ä»¶</p><p>ç»è¿‡æŸ¥çœ‹Nextçš„cssæ’ä»¶<code>next-css</code><a href="https://github.com/zeit/next-plugins/blob/master/packages/next-css/css-loader-config.js" target="_blank" rel="noopener">æºç </a>å®šä½åˆ°é—®é¢˜åœ¨å“ª</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isServer) &#123;</span><br><span class="line">  config.optimization.splitChunks.cacheGroups.styles = &#123;</span><br><span class="line">    name: <span class="string">'styles'</span>,</span><br><span class="line">    test: <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`\\.+(<span class="subst">$&#123;[...fileExtensions].join(<span class="string">'|'</span>)&#125;</span>)$`</span>),</span><br><span class="line">    chunks: <span class="string">'all'</span>,</span><br><span class="line">    enforce: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢é…ç½®çš„å«ä¹‰æ˜¯å…¨éƒ¨<code>fileExtensions</code>æ–‡ä»¶ä¸­å¼•å…¥çš„cssæ–‡ä»¶å…¨éƒ¨æŠ½å–å‡ºæ¥æ‰“åŒ…æˆ<code>styles.css</code>ï¼Œ <code>fileExtensions</code>å°±æ˜¯<code>webpacké…ç½®</code>ä¸­çš„<code>entry</code>è¿™ç§åšæ³•å¯¹å•é¡µåº”ç”¨æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå…¨éƒ¨ç»„ä»¶é¡µé¢cssæ–‡ä»¶é›†ä¸­æˆä¸€ä¸ªï¼ŒåŸæ¥çš„nä¸ªcssæ–‡ä»¶è¯·æ±‚å‡å°‘è‡³ä¸€ä¸ªï¼Œä½†æ˜¯å¯¹äºå¤šé¡µåº”ç”¨æ¥è¯´è¿™ç§åˆ†å‰²æ–¹å¼æ˜¯ä¸é€‚åˆçš„ï¼Œå› ä¸ºè·³è½¬é¡µé¢éœ€è¦é‡æ–°è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åšçš„æ˜¯å‡å°‘é¡µé¢æ–‡ä»¶çš„ä½“ç§¯ï¼Œæ‰€ä»¥è…¾è®¯æ–°é—»ä½¿ç”¨<code>styled-jsx</code>åº”è¯¥ä¹Ÿæ˜¯è¿™ä¸ªåŸå› </p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>:<br>ä½¿ç”¨<code>styled-jsx</code>æ–¹æ¡ˆï¼Œè‡ªåŠ¨æ‰“åŒ…åˆ°æ¯ä¸ªé¡µé¢å¯¹åº”çš„<code>js</code>ä¸­ï¼Œä½†ç”±äºå†™<code>styled-jsx</code>æ˜¯åœ¨<code>.tsx</code>ä¸­æ‰€ä»¥å¼€å‘çš„æ—¶å€™ä¸ä¼šæœ‰è¯­æ³•æç¤ºï¼Œæ‰€ä»¥å¯ä»¥ç”¨å¦ä¸€ç§æ–¹å¼å¼•å…¥scssæ–‡ä»¶è½¬åŒ–ä¸º<code>styled-jsx</code>ï¼Œéœ€è¦åœ¨<code>next.config.js</code>ä¸­é…ç½®ä¸€ä¸‹</p><blockquote><p>next.config.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">webpack: <span class="function">(<span class="params">config, &#123; defaultLoaders &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    config.module.rules.push(&#123;</span><br><span class="line">        test: <span class="regexp">/\.(sa|sc|c)ss$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">            defaultLoaders.babel,</span><br><span class="line">            &#123;</span><br><span class="line">                loader: <span class="built_in">require</span>(<span class="string">'styled-jsx/webpack'</span>).loader,</span><br><span class="line">                options: &#123;</span><br><span class="line">                    type: <span class="string">'scoped'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">'sass-loader'</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;)</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…¼å®¹AMP"><a href="#å…¼å®¹AMP" class="headerlink" title="å…¼å®¹AMP"></a>å…¼å®¹AMP</h2><p>ç”±äºæˆ‘å¸åšçš„æ˜¯æµ·å¤–äº§å“éœ€è¦åšè°·æ­ŒSEOï¼Œæ‰€ä»¥å°±ç”¨åˆ°äº†è°·æ­Œå¼€æºçš„AMPæ¡†æ¶ï¼Œè¿™ä¸ªæ¡†æ¶ä¸»è¦æ˜¯é’ˆå¯¹è°·æ­Œè¿›è¡Œä¼˜åŒ–ï¼Œå…¼å®¹AMPæ˜¯ç›®å‰ä½¿ç”¨Nextæœ€å¤§çš„é—®é¢˜ï¼Œå› ä¸ºè¿™ç›¸å½“äºæŠŠä¸¤ä¸ªé»‘ç›’æ¡†æ¶ç»„åˆä½¿ç”¨ï¼Œéš¾åº¦æ˜¯å¯æƒ³è€ŒçŸ¥çš„</p><p>AMPä¹Ÿæ˜¯ä¸€ä¸ªå¯¹å¯é…ç½®æ€§é™åˆ¶å¾ˆå¤§çš„æ¡†æ¶ï¼Œç‰¹åˆ«æ˜¯å¯¹cssåªèƒ½åµŒå…¥ä¸èƒ½å¼•å…¥ï¼Œå¹¶ä¸”å¤§å°é™åˆ¶åœ¨50000Byteså†…ï¼Œç„¶å†…åµŒçš„è‡ªå®šä¹‰cssè¦æ±‚ä»¥<code>&lt;style amp-custom&gt;.....&lt;/style&gt;</code>æ–¹å¼å†™å…¥ï¼Œå¦‚æœç¼ºå°‘<code>amp-custom</code>å°±æ— æ³•é€šè¿‡<code>amp validator</code>ã€‚è€ŒæŒ‰æ­£å¸¸çš„csså¼€å‘å¥—è·¯éœ€è¦å¯¹å…¨å±€æ ·å¼åšä¸€ä¸ªé€šç”¨å®šä¹‰ï¼Œç‰¹åˆ«æ˜¯ç§»åŠ¨ç«¯åšremé€‚é…éœ€è¦å¯¹htmlæ–‡æ¡£åšä¸€ä¸ªåˆå§‹å€¼font-sizeå®šä¹‰ã€‚</p><p>è€Œå¾ˆæ“è›‹çš„åœ¨<code>&lt;Head/&gt;</code>ç»„ä»¶ä½¿ç”¨<code>&lt;style&gt;...&lt;/style&gt;</code>å®šä¹‰å…¨å±€æ ·å¼æ˜¯ç¼ºå°‘ä¸Šé¢æåˆ°çš„<code>amp-custom</code>å±æ€§çš„ï¼Œ</p><p>ä½¿ç”¨<code>&lt;style jsx global&gt;...&lt;/style&gt;</code>åˆå¯èƒ½å‡ºç°åˆå§‹æ ·å¼åŠ è½½å¤±è´¥çš„æƒ…å†µ</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>:<br>åˆå§‹åŒ–æ ·å¼å­˜æ”¾åœ¨ä¸€ä¸ª<code>reset</code>æ–‡ä»¶ï¼Œç„¶ååœ¨é¡µé¢æ ·å¼æ–‡ä»¶ä¸­å¼•å…¥ã€‚</p><h2 id="Typescriptç¼–è¯‘å…¼å®¹"><a href="#Typescriptç¼–è¯‘å…¼å®¹" class="headerlink" title="Typescriptç¼–è¯‘å…¼å®¹"></a>Typescriptç¼–è¯‘å…¼å®¹</h2><p>åœ¨ä½¿ç”¨Egg.jsæ–‡æ¡£<a href="https://eggjs.org/zh-cn/tutorials/typescript.html" target="_blank" rel="noopener">å…³äºtypescripté…ç½®</a>çš„çš„æ—¶å€™å½“eggç«¯ä½¿ç”¨<code>esmodule</code>è§„èŒƒå¼€å‘ä¼šæ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œç»è¿‡æˆ‘æœ¬äººçš„è¸©å‘ï¼Œç»ˆäºå‘ç°æ˜¯tsconfigé…ç½®æœ‰å…³ï¼Œæ˜¯çš„æ²¡é”™ï¼Œå°±è·Ÿä¸‹é¢è¿™ä¸€è¡Œæœ‰å…³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;module&quot;: &quot;esnext&quot;</span><br></pre></td></tr></table></figure><p><code>module</code>çš„æ„æ€æ˜¯æŒ‡å®šç”Ÿæˆå“ªä¸ªæ¨¡å—ç³»ç»Ÿä»£ç ï¼Œè€Œå› ä¸ºnodejsæ‰§è¡Œçš„æ˜¯<code>common.js</code>è§„èŒƒï¼Œæ‰€ä»¥æ”¹æˆ<code>common.js</code>nodeç«¯ä½¿ç”¨esmoduleè§„èŒƒè¿›è¡Œç¼–è¯‘å°±æ²¡æœ‰é—®é¢˜ï¼Œä½†æ‚²å‰§çš„æ˜¯è¿™ä¸ªé…ç½®nextæ˜¯å¼ºåˆ¶æ€§çš„ï¼Œå°±ç®—æ”¹æˆ<code>common.js</code>ä¹Ÿä¼šå˜æˆ<code>esnext</code>ï¼Œsoï¼Œå…ˆå‡‘åˆç€ç”¨ï¼šï¼‰</p><p>ä¸‹é¢æ˜¯æˆ‘åŸºäºå…¬å¸ç°æœ‰tsé¡¹ç›®çš„tsconfig.jsonæ–‡ä»¶é…ç½®çš„ä¸¤ä¸ªtsconfigæ–‡ä»¶ï¼Œä¸ºå•¥ä¼šæœ‰ä¸¤ä¸ªå‘¢ï¼Œå› ä¸ºåœ¨Nextv9ç‰ˆæœ¬ä¸­æ”¯æŒtypescript0é…ç½®ï¼Œæ‰€ä»¥ä¼šåœ¨ç¼–è¯‘ä¸­è‡ªåŠ¨ç”Ÿæˆ<code>tsconfig</code>é…ç½®ï¼Œä½†æ˜¯è¿™ä¸ªé…ç½®å¯¹ç¼–è¯‘eggç«¯å°±ä¸å¤ªè¡Œï¼Œæ‰€ä»¥åªèƒ½ç”¨è¿™ç§æŠ˜ä¸­åŠæ³•ï¼Œ<code>ts.egg.json</code>ç”¨äºç¼–è¯‘egg,<code>tsconfig.json</code>ç¼–è¯‘<code>next</code>ï¼Œç„¶å<code>tsconfig.json</code>å»ç»§æ‰¿<code>ts.egg.json</code>ï¼Œè¿˜æœ‰å°±æ˜¯éœ€è¦ä¿æŒ<code>typescript</code>ç‰ˆæœ¬åœ¨3.7ä»¥ä¸Šï¼Œè¿™æ ·åœ¨å¼€å‘å’Œç”Ÿäº§ç¼–è¯‘ä¸­å°±ä¸ä¼šäº§ç”Ÿç¼–è¯‘æŠ¥é”™</p><blockquote><p>tsconfig.json</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;extends&quot;: &quot;./ts.egg.json&quot;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ts.egg.json </p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;compileOnSave&quot;: true,</span><br><span class="line">  &quot;compilerOptions&quot;: &#123;</span><br><span class="line">    &quot;moduleResolution&quot;: &quot;node&quot;,</span><br><span class="line">    &quot;sourceMap&quot;: true,</span><br><span class="line">    &quot;removeComments&quot;: true,</span><br><span class="line">    &quot;noImplicitAny&quot;: false,</span><br><span class="line">    &quot;allowSyntheticDefaultImports&quot;: true,</span><br><span class="line">    &quot;lib&quot;: [&quot;es2015&quot;, &quot;es2016&quot;, &quot;es2017.object&quot;, &quot;dom&quot;, &quot;es2018.promise&quot;, &quot;es2019&quot;],</span><br><span class="line">    &quot;jsx&quot;: &quot;preserve&quot;,</span><br><span class="line">    &quot;downlevelIteration&quot;: true,</span><br><span class="line">    &quot;target&quot;: &quot;es2017&quot;,</span><br><span class="line">    &quot;experimentalDecorators&quot;: true,</span><br><span class="line">    &quot;emitDecoratorMetadata&quot;: true,</span><br><span class="line">    &quot;charset&quot;: &quot;utf8&quot;,</span><br><span class="line">    &quot;allowJs&quot;: false,</span><br><span class="line">    &quot;noEmitOnError&quot;: false,</span><br><span class="line">    &quot;allowUnreachableCode&quot;: false,</span><br><span class="line">    &quot;allowUnusedLabels&quot;: false,</span><br><span class="line">    &quot;noFallthroughCasesInSwitch&quot;: true,</span><br><span class="line">    &quot;skipLibCheck&quot;: true,</span><br><span class="line">    &quot;skipDefaultLibCheck&quot;: true,</span><br><span class="line">    &quot;importHelpers&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;exclude&quot;: [</span><br><span class="line">    &quot;app/public&quot;,</span><br><span class="line">    &quot;node_modules*&quot;,</span><br><span class="line">    &quot;dist/*&quot;,</span><br><span class="line">    &quot;build/*&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿäº§ç¼–è¯‘çš„æ—¶å€™éœ€è¦å…ˆæŠŠeggè‡ªå®šä¹‰é…ç½®(<code>app.ts</code>å’Œ<code>ssr.ts</code>)æ‰“åŒ…ç¼–è¯‘ï¼Œæ¨èä½¿ç”¨<code>npm run local-tsc</code>è¿›è¡Œæœ¬åœ°ç¼–è¯‘ï¼Œæ‰“åŒ…åˆ°çº¿ä¸ŠæœåŠ¡å™¨åå†ä½¿ç”¨<code>npm run tsc</code>ç¼–è¯‘<code>egg</code>ç«¯çš„ä¸šåŠ¡ä»£ç </p><blockquote><p>package.json</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;tsc&quot;: &quot;ets &amp;&amp; tsc -p ts.egg.json&quot;,</span><br><span class="line">  &quot;local-tsc&quot;: &quot;tsc app.ts &amp;&amp; tsc ./server/ssr.ts&quot;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h2 id="å…¶ä»–æ€»ç»“å°†æŒç»­æ›´æ–°ï¼Œæ•¬è¯·æœŸå¾…ï½ï½"><a href="#å…¶ä»–æ€»ç»“å°†æŒç»­æ›´æ–°ï¼Œæ•¬è¯·æœŸå¾…ï½ï½" class="headerlink" title="å…¶ä»–æ€»ç»“å°†æŒç»­æ›´æ–°ï¼Œæ•¬è¯·æœŸå¾…ï½ï½"></a>å…¶ä»–æ€»ç»“å°†æŒç»­æ›´æ–°ï¼Œæ•¬è¯·æœŸå¾…ï½ï½</h2>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡ä¼šæ€»ç»“ä½¿ç”¨Next.jsåœ¨å…·ä½“ä¸šåŠ¡åœºæ™¯ä¸‹ç¢°åˆ°çš„ä¸€äº›å¤§å‘ä»¥åŠå…·ä½“è§£å†³æ–¹æ¡ˆï¼Œåœ¨å¼€å§‹æ€»ç»“å‰å…ˆè¡¨è¾¾ä¸‹å¯¹ZEITå›¢é˜Ÿçš„æ•¬ä½©ï¼Œæ„Ÿè°¢ğŸ™ä»–ä»¬å¼€æºå‡ºä¸€æ¬¾ä¼˜ç§€çš„åŒæ„æ¡†æ¶ï¼Œè§£æ•‘äº†æ›¾ç»è›‹ç–¼çš„é™·åœ¨ä½¿ç”¨æ¨¡ç‰ˆå¼•æ“åšSSRé¡¹ç›®çš„å¼€å‘è€…(æ¯”å¦‚æˆ‘)ï¼Œé€šè¿‡Next.jsé‡æ„åçš„é¡¹ç›®æ›´åŠ è½»é‡åŒ–ï¼Œæ€§èƒ½ä¸Šä¹Ÿæœ‰å¤§å¹…åº¦çš„æå‡ï¼Œå¦‚ä¸‹å›¾&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>æŠ“å–å’Œåˆ†æNodeç«¯æ€§èƒ½</title>
    <link href="http://yoursite.com/2020/01/06/1/"/>
    <id>http://yoursite.com/2020/01/06/1/</id>
    <published>2020-01-06T14:37:55.000Z</published>
    <updated>2020-01-10T14:08:17.574Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨åšæ€§èƒ½ä¼˜åŒ–çš„æ—¶å€™å…³æ³¨çš„é‡ç‚¹ä¸€èˆ¬æ˜¯webç«¯çš„æ€§èƒ½ï¼Œä½†åœ¨æœ‰Nodeä½œä¸ºä¸­é—´å±‚ä½¿ç”¨çš„æƒ…å†µä¸‹Nodeç«¯çš„æ€§èƒ½åŒæ ·éœ€è¦å»å…³æ³¨ã€‚</p><p>æ¯”å¦‚é‡åˆ°ç½‘ç»œè¯·æ±‚æ…¢çš„æƒ…å†µï¼ŒåŸå› é™¤äº†ç½‘é€Ÿé—®é¢˜ä»¥å¤–å¯èƒ½ä¹Ÿæ˜¯Nodeç«¯å“åº”æ—¶é—´è¾ƒé•¿ï¼Œæ‰€ä»¥å°±éœ€è¦å»æŠ“å–å‡ºæ€§èƒ½è€—è´¹ç‚¹åœ¨å“ªé‡Œã€‚</p><a id="more"></a><h2 id="æ€§èƒ½æŒ‡æ ‡"><a href="#æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡"></a>æ€§èƒ½æŒ‡æ ‡</h2><p>æœåŠ¡ç«¯çš„æ€§èƒ½æŒ‡æ ‡æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å…³æ³¨RTå’ŒQPSè¿™ä¸¤ä¸ªå½±å“é¡µé¢æ€§èƒ½å’ŒæœåŠ¡å™¨æ¶ˆè€—çš„å°±è¡Œäº†</p><ul><li>RTï¼šå“åº”æ—¶é•¿ï¼Œç³»ç»Ÿå¯¹è¯·æ±‚ä½œå‡ºçš„å“åº”æ—¶é—´(å•æ¬¡è¯·æ±‚è€—æ—¶)</li><li>QPSï¼šå•å°æœºå™¨æ¯ç§’å¤„ç†æŸ¥è¯¢æ•°é‡<br>QPSçš„ç»Ÿè®¡æ–¹å¼ï¼š<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">QPS = æ€»è¯·æ±‚æ•° / ( è¿›ç¨‹æ€»æ•° * è¯·æ±‚æ—¶é—´ )</span><br></pre></td></tr></table></figure></li></ul><p>å‡å¦‚ä¸€ä¸ªè¯·æ±‚çš„RTä»500msé™ä½åˆ°100msï¼Œé‚£ä¹ˆç†è®ºä¸ŠQPSå°±å¯ä»¥æå‡4å€ï¼Œä»¥å‰éœ€è¦äº”å°æœºå™¨æ‰èƒ½æ‰›ä½çš„æµé‡ç°åœ¨åªéœ€è¦ä¸€å°ï¼Œè¿™æ ·å¯ä»¥åœ¨å‡å°‘å“åº”æ—¶é—´çš„æ—¶å€™åŒæ—¶å‡å°‘æœåŠ¡å™¨èµ„æºæ¶ˆè€—</p><h2 id="æŠ“å–Nodeç«¯æ€§èƒ½"><a href="#æŠ“å–Nodeç«¯æ€§èƒ½" class="headerlink" title="æŠ“å–Nodeç«¯æ€§èƒ½"></a>æŠ“å–Nodeç«¯æ€§èƒ½</h2><p>é‚£åº”è¯¥æ€æ ·å»æŠ“å–Nodeç«¯è¯·æ±‚çš„RTå‘¢ï¼ŒNodeæœ¬èº«æ˜¯è‡ªå¸¦åˆ†æprofileçš„ï¼Œä½†æ˜¯å®ƒå¯¼å‡ºçš„æ˜¯æ—¥å¿—åˆ†æï¼Œä¸å¤ªå¥½åˆ¤æ–­æ€§èƒ½æ¶ˆè€—ç‚¹åœ¨ä»€ä¹ˆåœ°æ–¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Concurrency Level:      20</span><br><span class="line">Time taken for tests:   46.932 seconds</span><br><span class="line">Complete requests:      250</span><br><span class="line">Failed requests:        0</span><br><span class="line">Keep-Alive requests:    250</span><br><span class="line">Total transferred:      50250 bytes</span><br><span class="line">HTML transferred:       500 bytes</span><br><span class="line">Requests per second:    5.33 [#/sec] (mean)</span><br><span class="line">Time per request:       3754.556 [ms] (mean)</span><br><span class="line">Time per request:       187.728 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1.05 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%   3755</span><br><span class="line">  66%   3804</span><br><span class="line">  75%   3818</span><br><span class="line">  80%   3825</span><br><span class="line">  90%   3845</span><br><span class="line">  95%   3858</span><br><span class="line">  98%   3874</span><br><span class="line">  99%   3875</span><br><span class="line"> 100%   4225 (longest request)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨<a href="https://www.npmjs.com/package/v8-profiler-next" target="_blank" rel="noopener">v8-profiler-next</a>ï¼Œè¿™ä¸ªæ’ä»¶å¯ä»¥å¯¹CPUå’Œå †å†…å­˜è¿›è¡ŒæŠ“å–ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦çš„æ˜¯è¯·æ±‚è€—æ—¶çš„æ•°æ®æ‰€ä»¥åªæŠ“CPUå°±è¡Œäº†ã€‚</p><p>åœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒä¸‹è¿˜éœ€è¦ä½¿ç”¨<a href="https://www.npmjs.com/package/loadtest" target="_blank" rel="noopener">loadtest</a>å‹åŠ›æµ‹è¯•å·¥å…·åšä¸€æ¬¡CPUå¯†é›†è®¡ç®—è·å–è€—æ—¶å¹³å‡å€¼ã€‚</p><p>ä»¥ç”µå½±ç«™è¯·æ±‚ä¸ºä¾‹å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router</span></span><br><span class="line"><span class="comment">// é¦–é¡µè¯·æ±‚api</span></span><br><span class="line">router.get(<span class="string">'/api/home/movie-list'</span>, controller.home.getMovieList)</span><br><span class="line"><span class="comment">// cpuæ•°æ®ä¸ŠæŠ¥</span></span><br><span class="line">router.get(<span class="string">'/api/cpuprofile'</span>,controller.home.exportCPUProfile)</span><br><span class="line"></span><br><span class="line"><span class="comment">// controller/home</span></span><br><span class="line"><span class="keyword">const</span> profiler = <span class="built_in">require</span>(<span class="string">'v8-profiler-next'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">async</span> getMovieList(ctx) &#123;</span><br><span class="line">  <span class="keyword">return</span> ctx.helper.commonStr(&#123; ctx, <span class="attr">type</span>: â€œ<span class="keyword">get</span>â€, serverName: â€œhomeâ€, fnName: â€œgetHomeListâ€ &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// service/home</span><br><span class="line">async getHomeList(opt: &#123; domain: string, <span class="attr">isAmp</span>: string &#125;) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; domain, isAmp &#125; = opt</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> url = <span class="keyword">this</span>.ctx.helper.parseParam(&#123;</span><br><span class="line">      auth: <span class="keyword">this</span>.app.config.apiAuth,</span><br><span class="line">      domain</span><br><span class="line">    &#125;, API.MOVIE_HOME_LIST_URL)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> data: any = <span class="keyword">await</span> <span class="keyword">this</span>.ctx.service.mc.getMC(url)</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      ..</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// controller/home</span></span><br><span class="line"><span class="keyword">async</span> exportCPUProfile() &#123;</span><br><span class="line">    profiler.startProfiling(<span class="string">'CPU profile'</span>)</span><br><span class="line">    <span class="comment">//Stop Profiling after default time 60s</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> profile = profiler.stopProfiling()</span><br><span class="line">      profile.export()</span><br><span class="line">        .pipe(fs.createWriteStream(<span class="string">`cpuprofile-<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span>.cpuprofile`</span>))</span><br><span class="line">        .on(<span class="string">'finish'</span>, () =&gt; profile.delete())</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'finish'</span>)</span><br><span class="line">    &#125;, <span class="number">60000</span>)</span><br><span class="line">    <span class="keyword">this</span>.ctx.body = &#123;</span><br><span class="line">      status: <span class="string">'success'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ç„¶åå¼€ä¸¤ä¸ªç»ˆç«¯åˆ†åˆ«è¿è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:8083/api/cpuprofile</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loadtest http://127.0.0.1:8083/api/home/movie-list/?domain=movierulz.video&amp;&amp;isAmp=false -n 100</span><br></pre></td></tr></table></figure><p>ç»“æŸæŠ“å–åå¯¼å‡ºçš„<code>.cpuprofile</code>æ–‡ä»¶æˆ‘ä»¬æ˜¯ä¸èƒ½ç›´æ¥å»çœ‹çš„ï¼Œè¿˜è¦é€šè¿‡<strong>Chrome devtools</strong>æä¾›çš„CPUåˆ†æé¡µé¢å±•ç¤ºæŠ“å–åˆ°çš„æ•°æ®ã€‚<br><img src="/2020/01/06/1/01.png" alt="01.png"><br>è¿›å…¥<strong>JavaScript Profiler</strong>é¡µé¢åç‚¹å‡»<strong>Load</strong>æŒ‰é’®å¯¼å…¥ä¸Šé¢çš„profileæ–‡ä»¶å°±èƒ½å¾—åˆ°åˆ†æç»“æœã€‚<br><img src="/2020/01/06/1/02.png" alt="02.png"><br>åˆ†æç»“æœæœ‰ä¸¤ä¸ªæŒ‡æ ‡ï¼š</p><ul><li><strong>Self Time</strong>: å‡½æ•°è°ƒç”¨æ‰€è€—è´¹çš„æ—¶é—´ï¼Œä»…åŒ…å«å‡½æ•°æœ¬èº«çš„å£°æ˜ï¼Œä¸åŒ…å«ä»»ä½•å­å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ã€‚</li><li><strong>Total Time</strong>: å‡½æ•°è°ƒç”¨æ‰€è€—è´¹çš„æ€»æ—¶é—´ï¼ŒåŒ…å«å‡½æ•°æœ¬èº«çš„å£°æ˜åŠæ‰€æœ‰å­å‡½æ•°æ‰§è¡Œæ—¶é—´</li></ul><p>æ‰€ä»¥åªéœ€è¦çœ‹<strong>Total Time</strong>å³å¯ï¼Œç„¶åæ ¹æ®<strong>Total Time</strong>å»å®šä½é—®é¢˜ä½œå‡ºå…·ä½“çš„ä¼˜åŒ–æªæ–½ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>1.<a href="https://yq.aliyun.com/articles/694994?spm=a2c4e.11155435.0.0.43da6154bJgrQM" target="_blank" rel="noopener">Node.js åº”ç”¨æ•…éšœæ’æŸ¥æ‰‹å†Œ â€”â€” æ­£ç¡®æ‰“å¼€ Chrome devtools</a><br>2.<a href="https://xiaozhuanlan.com/Nodejs-Guide/8209375641" target="_blank" rel="noopener">ä½¿ç”¨ v8-profiler åˆ†æ CPU çš„ä½¿ç”¨æƒ…å†µ</a><br>3.<a href="https://juejin.im/entry/5a3b46676fb9a04512391cd1" target="_blank" rel="noopener">ReactåŒæ„ä¸æè‡´çš„æ€§èƒ½ä¼˜åŒ–</a><br>4.<a href="https://blog.51cto.com/qiangsh/1979617" target="_blank" rel="noopener">QPSã€PV ã€RTï¼ˆå“åº”æ—¶é—´ï¼‰ä¹‹é—´çš„å…³ç³»</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;åœ¨åšæ€§èƒ½ä¼˜åŒ–çš„æ—¶å€™å…³æ³¨çš„é‡ç‚¹ä¸€èˆ¬æ˜¯webç«¯çš„æ€§èƒ½ï¼Œä½†åœ¨æœ‰Nodeä½œä¸ºä¸­é—´å±‚ä½¿ç”¨çš„æƒ…å†µä¸‹Nodeç«¯çš„æ€§èƒ½åŒæ ·éœ€è¦å»å…³æ³¨ã€‚&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚é‡åˆ°ç½‘ç»œè¯·æ±‚æ…¢çš„æƒ…å†µï¼ŒåŸå› é™¤äº†ç½‘é€Ÿé—®é¢˜ä»¥å¤–å¯èƒ½ä¹Ÿæ˜¯Nodeç«¯å“åº”æ—¶é—´è¾ƒé•¿ï¼Œæ‰€ä»¥å°±éœ€è¦å»æŠ“å–å‡ºæ€§èƒ½è€—è´¹ç‚¹åœ¨å“ªé‡Œã€‚&lt;/p&gt;
    
    </summary>
    
    
    
  </entry>
  
</feed>
